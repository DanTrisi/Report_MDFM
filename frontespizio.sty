\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{frontespizio}[2025/11/02 UniTN Frontespizio Package - Modified]

\RequirePackage{setspace}
\RequirePackage{etoolbox}
\RequirePackage{tikz}
\RequirePackage{graphicx}
\RequirePackage{amssymb}
\RequirePackage{ifthen}

% === Nuovi comandi aggiunti ===
\newcommand{\ProjectSubtitle}[1]{\def\@ProjectSubtitle{#1}}
\newcommand{\StudentList}[1]{\def\@StudentList{#1}}

% Valori di default (evitano errori se non definiti)
\ProjectSubtitle{}
\StudentList{}

% === Flags, counters ===
\def\@relatorilist{}
\def\@topPosition{top}
\def\@belowUniPosition{below-uni}
\def\@aboveTitlePosition{above-title}
\def\@belowTitlePosition{below-title}
\def\@noLogo{no-logo}

% === Helper functions ===
\newcommand{\countlist}[1]{%
  \setcounter{listcount}{0}%
  \renewcommand*{\do}[1]{\stepcounter{listcount}}%
  \docsvlist{#1}%
}

\newcommand{\myprintlist}[1]{%
    \count255=0
    \def\do##1{\advance\count255 1 \chardef\finalitem=\count255 }%
    \dolistloop{#1}%
    \count255=0
    \def\do##1{\advance\count255 1
    \ifnum\count255=\finalitem
        \ifnum\count255>1
            \\
        \fi
    \else
        \ifnum\count255=1
        \else
            \\
        \fi
    \fi##1}
    \dolistloop{#1}
}

\newcommand{\printcandidateblock}[1]{%
    \ifx\@StudentList\@empty
        \hfill
        \@Candidato\\
        \hbox{}\hfill{\scshape\@Matricola}
    \else
        \raggedleft
        \@StudentList
    \fi
}

\newcommand{\ifstrequals}[4]{%
    \def\firstOperand{#1}%
    \def\secondOperand{#2}%
    \ifx\firstOperand\secondOperand%
        #3%
    \else%
        #4%
    \fi
}

% === Public commands ===
\newcommand{\Universita}[1]{\newcommand{\@Universita}{#1}}
\newcommand{\Facolta}[1]{\newcommand{\@Facolta}{#1}}
\newcommand{\Dipartimento}[1]{\newcommand{\@Dipartimento}{#1}}
\newcommand{\CorsoDiLaurea}[1]{\newcommand{\@CorsoDiLaurea}{#1}}
\newcommand{\AnnoAccademico}[1]{\newcommand{\@AnnoAccademico}{#1}}
\newcommand{\Logo}[1]{\newcommand{\@Logo}{#1}}
\newcommand{\Relatore}[1]{\listadd{\@relatorilist}{#1}}
\newcommand{\@Candidato}{}
\newcommand{\Candidato}[1]{\renewcommand{\@Candidato}{#1}}
\newcommand{\@Titolo}{}
\newcommand{\Titolo}[1]{\renewcommand{\@Titolo}{#1}}
\newcommand{\Matricola}[1]{\newcommand{\@Matricola}{#1}}
\newcommand{\DataEsame}[1]{\newcommand{\@DataEsame}{#1}}
\newcommand{\Materia}[1]{\def\@Materia{#1}}
\newcommand{\FrontespizioAlt}[1]{\newcommand{\@FrontespizioAlt}{#1}}
\newcommand{\@LogoPosition}{top}
\newcommand{\LogoPosition}[1]{\renewcommand{\@LogoPosition}{#1}}
\newcommand{\LogoSfondo}[1]{\newcommand{\@LogoSfondo}{#1}}
\newcommand{\opacitaSfondo}[1]{\newcommand{\@opacitaSfondo}{#1}}

\newcommand{\@RelatoreLabel}{Relatore}
\newcommand{\RelatoreLabel}[1]{\renewcommand{\@RelatoreLabel}{#1}}
\newcommand{\@CorrelatoreLabel}{Correlatore}
\newcommand{\CorrelatoreLabel}[1]{\renewcommand{\@CorrelatoreLabel}{#1}}
\newcommand{\@CandidatoLabel}{Students}
\newcommand{\CandidatoLabel}[1]{\renewcommand{\@CandidatoLabel}{#1}}
\newcommand{\@LogoWidth}{3cm}
\newcommand{\LogoWidth}[1]{\renewcommand{\@LogoWidth}{#1}}
\newcommand{\@relandcorrelsep}{1.5ex}
\newcommand{\relandcorrelsep}[1]{\renewcommand{\@relandcorrelsep}{#1}}

\newcommand{\sep}{%
    \vspace{5pt}
    \centerline{$\sim \cdot \sim$}
}

% === FRONT PAGE MODIFICATA ===
\newcommand{\makefrontpage}{%
    \begin{titlepage}%
    \ifdefined\@LogoSfondo
        \ifdefined\@opacitaSfondo 
        \else
            \def\@opacitaSfondo{0.05}
        \fi
        \AddToHook{shipout/firstpage}{%
            \begin{tikzpicture}[remember picture, overlay]
                \node[opacity=\@opacitaSfondo] at ([xshift=-10cm,yshift=-19cm] current page.north east)
                    {\includegraphics{\@LogoSfondo}};
            \end{tikzpicture}
        }
    \fi
        \begin{center}
            \setstretch{1.2}
            \setlength{\parskip}{2ex}

            % --- logo top ---
            \ifdefined\@FrontespizioAlt \else
                \ifdefstrequal{\@LogoPosition}{\@topPosition}{
                    \includegraphics[width=\@LogoWidth]{\@Logo}
                    \vspace{10pt}
                }{}
            \fi

            % --- intestazioni universitarie ---
            \ifdefined\@Universita
                {\LARGE\textsc{\@Universita}}
            \fi

            \ifdefined\@FrontespizioAlt \else
                \ifdefstrequal{\@LogoPosition}{\@belowUniPosition}{
                    \includegraphics[width=\@LogoWidth]{\@Logo}
                }{}
            \fi

            \ifdefined\@Facolta
                {\newline\Large\textsc{\@Facolta}}
            \fi
            \ifdefined\@Dipartimento
                {\Large\textsc{\@Dipartimento}}
            \fi
            \ifdefined\@CorsoDiLaurea
                {\Large\textsc{\@CorsoDiLaurea}}
            \fi
            \ifdefined\@Materia
                {\large\textsc{\@Materia}}
            \fi
            \ifdefined\@AnnoAccademico
                \sep
                {\large\textsc{\@AnnoAccademico}}
            \fi

            \vfill

            % --- nuova scritta in piccolo sopra al titolo ---
            \ifx\@ProjectSubtitle\@empty
            \else
                {\small\textit{\@ProjectSubtitle}}\\[0.8cm]
            \fi

            % --- titolo principale ---
            {\Huge\textbf{\@Titolo}}

            \vfill
            \ifdefined\@FrontespizioAlt \else
                \ifdefstrequal{\@LogoPosition}{\@belowTitlePosition}{
                    \includegraphics[width=\@LogoWidth]{\@Logo}
                }{}
            \fi

            \vfill
            \setstretch{1}

            % --- blocchi relatore / candidati ---
            \begin{minipage}[t]{.49\textwidth}
                \normalsize
                \textbf{\@RelatoreLabel}\par
                \myprintlist{\@relatorilist}
            \end{minipage}\hfill%
            \begin{minipage}[t]{.45\textwidth}
                \normalsize
                \hfill\textbf{\@CandidatoLabel}\par
                \printcandidateblock{\@Candidato}
            \end{minipage}%

            \vfill
            \ifdefined\@DataEsame
                \vspace{10mm}
                \raggedright
                {\large\textsc{Final examination date:} \@DataEsame}
                \rule{\textwidth}{0.5mm}
            \fi
        \end{center}
    \end{titlepage}
}

\newcommand{\makefrontpagealt}{
    \FrontespizioAlt{}
    \makefrontpage%
    \undef\@FrontespizioAlt
}
